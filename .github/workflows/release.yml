name: Release

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # Auto-approve release PR
  auto-approve:
    name: Auto-approve Release PR
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.user.login == 'github-actions[bot]' &&
      startsWith(github.event.pull_request.head.ref, 'release-please--')
    permissions:
      pull-requests: write
    steps:
      - name: Approve PR
        run: gh pr review "$PR_NUMBER" --approve
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Auto-merge release PR after checks pass
  auto-merge:
    name: Auto-merge Release PR
    runs-on: ubuntu-latest
    needs: auto-approve
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.user.login == 'github-actions[bot]' &&
      startsWith(github.event.pull_request.head.ref, 'release-please--')
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Enable auto-merge
        run: gh pr merge "$PR_NUMBER" --auto --squash
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
      pull-requests: write
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      pr_number: ${{ steps.release.outputs.pr }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: php
          token: ${{ secrets.GITHUB_TOKEN }}

  build-release:
    name: Build Release Assets
    runs-on: ubuntu-latest
    needs: release
    if: ${{ needs.release.outputs.release_created }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, json, bcmath

      - name: Install Composer dependencies (production)
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      - name: Install npm dependencies
        run: npm ci

      - name: Build production assets
        run: npm run build

      - name: Create release archive
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          if [ -z "$VERSION" ]; then
            echo "Error: Version is empty"
            exit 1
          fi
          ARCHIVE_NAME="thaivote-${VERSION}.tar.gz"
          echo "Creating archive: $ARCHIVE_NAME"
          # Create archive excluding dev files and the archive itself
          tar -czvf "../${ARCHIVE_NAME}" \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='tests' \
            --exclude='.env' \
            --exclude='.env.*' \
            --exclude='*.log' \
            --exclude='*.tar.gz' \
            --exclude='coverage' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            .
          mv "../${ARCHIVE_NAME}" .

      - name: Upload release archive
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release.outputs.tag_name }}
          files: thaivote-${{ needs.release.outputs.version }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [release, build-release]
    if: ${{ needs.release.outputs.release_created }}
    steps:
      - name: Create deployment summary
        run: |
          echo "## Release ${{ needs.release.outputs.version }} Created! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download release archive from releases page" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract to server: \`tar -xzvf thaivote-${{ needs.release.outputs.version }}.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Run: \`./deploy.sh\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ needs.release.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
